<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.9.1/jquery.min.js"></script>
</head>

<body>

	<table id="table_merge">
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>

	</table>

	<script type="text/javascript">
		$(function(){
			
			var mouseParams = {
				downCol : -1,
				upCol : -1,
				downRow : -1,
				upRow : -1
			};

			var tableMerge = $("#table_merge");

			tableMerge.find("td").mousedown(function(){
				mouseParams.downCol = this.cellIndex;
				console.debug("downCol", this.cellIndex);
			}).mouseup(function(){
				mouseParams.upCol = this.cellIndex;
				console.debug("upCol", this.cellIndex);
			}).css("width", 100).css("height", 100).css("border", "1px solid ");

			tableMerge.find("tr").mousedown(function(){
				mouseParams.downRow = this.rowIndex;
				console.debug("downRow", this.rowIndex);
			}).mouseup(function(){
				mouseParams.upRow = this.rowIndex;
				console.debug("upRow", this.rowIndex);
				
				merge(mouseParams);
			});

			var rowNum = document.getElementById("table_merge").rows.length;
			var colNum = document.getElementById("table_merge").rows[0].cells.length;
			function merge(params){

				// 1. 判断可不可以合并
				params = correctParams(params);

				// 2. 设置新的rowspan和colspan
				var $cellStart = $("td").get(params.downRow * colNum + params.downCol);
				var $cellend = $("td").get(params.upRow * colNum + params.upCol);

				var rowSpanNum = params.upRow - params.downRow;
				var colSpanNum = params.upCol - params.downCol;

				tempRowSpan = (rowSpanNum + $cellend.rowSpan);
				tempColSpan = (colSpanNum + $cellend.colSpan);
				if(!canMerge(params,rowSpanNum,colSpanNum,tempRowSpan,tempColSpan,$cellend)){
					return ;
				}

				$cellStart.rowSpan = tempRowSpan;
				$cellStart.colSpan = tempColSpan;


				// 3. 设置宽度
				$($cellStart).css("width", $cellStart.colSpan * 100 + "px")
							.css("height", $cellStart.rowSpan * 100 + "px");

				console.debug("$cellStart.rowSpan", $cellStart.rowSpan);
				console.debug("$cellStart.colSpan", $cellStart.colSpan);
				
				// 4. 删除多余单元格
				hideTd($("td"), params.downRow, params.downCol, $cellend.rowSpan + params.upRow - 1, $cellend.colSpan + params.upCol - 1);
			}

			function hideTd($tdArray, startRow, startCol, endRow, endCol){
				$.each($tdArray, function(index, element){
					var row = Math.floor(index/colNum);
					var col = index % colNum;
					
					var isOwn = (row == startRow && col == startCol);
					if(row >= startRow && row <= endRow
						&& col >= startCol && col <= endCol
						&& !isOwn){
						console.debug("Hidden Element", "row:" + row + "; col:" + col + ";");
						// hide
						element.hidden = true;		
					}
					//console.debug("element", element);
				});
			}

			function canMerge(params,rowSpanNum,colSpanNum,tempRowSpan,tempColSpan,$cellend){
				//
				if(params.downCol == params.upCol && params.downRow == params.upRow){
					return false;
				}

				if((rowSpanNum == 0 || colSpanNum == 0) && (tempRowSpan !== $cellend.rowSpan && tempColSpan !== $cellend.colSpan)){
					return false;
				}

				return true;
			}

			function correctParams(params){
				
				if(params.downRow >= params.upRow && params.downCol >= params.upCol){
					//  右下角，交换
					var temp = params.downRow;
					params.downRow = params.upRow;
					params.upRow = temp;

					temp = params.downCol;
					params.downCol = params.upCol;
					params.upCol = temp;

				} else if (params.downRow > params.upRow && params.downCol < params.upCol) {
					// 左下角
					var temp = params.downRow;
					params.downRow = params.upRow;
					params.upRow = temp;
				} else if (params.downRow < params.upRow && params.downCol > params.upCol) {
					// 右上角
					var temp = params.downCol;
					params.downCol = params.upCol;
					params.upCol = temp;
				}
				return params;
			}
		});


	</script>

</body>

</html>